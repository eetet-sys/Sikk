<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‹ê²° - ì •ë°€ ìš´ëª… ì²˜ë°© ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Song+Myung&display=swap');
        :root { --paper: #fdfcf8; --ink: #1a1a1a; --wood: #4A6741; --fire: #A24841; --earth: #C29A5B; --metal: #7D7D7D; --water: #3E5266; }
        body { font-family: 'Noto Serif KR', serif; background-color: #dcd9d0; margin: 0; padding: 15px; color: var(--ink); line-height: 1.6; }
        .app-container { max-width: 420px; margin: auto; background: var(--paper); border: 1px solid #c9c4b9; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { padding: 40px 20px; text-align: center; border-bottom: 1px double #d1cdbf; }
        .header h1 { font-family: 'Song Myung', serif; font-size: 2.5rem; margin: 0; letter-spacing: 12px; }
        .content { padding: 25px; }
        .section-title { font-size: 0.85rem; font-weight: 700; margin: 20px 0 10px; border-left: 3px solid var(--ink); padding-left: 10px; }
        input, select { width: 100%; border: none; border-bottom: 1px solid #d1cdbf; background: transparent; padding: 10px 5px; margin-bottom: 15px; font-family: inherit; font-size: 0.9rem; outline: none; box-sizing: border-box; }
        button { width: 100%; padding: 18px; background: var(--ink); color: #fff; border: none; font-weight: 700; cursor: pointer; letter-spacing: 2px; margin-top: 10px; }
        #prescriptionCard { display: none; background: var(--paper); padding: 30px; border: 8px double #d1cdbf; margin: 20px; text-align: center; }
        .tag-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .food-tag { padding: 5px 12px; border: 1px solid #d1cdbf; font-size: 0.8rem; border-radius: 20px; background: #fff; cursor: pointer; }
        .warning-box { font-size: 0.75rem; color: #a24841; background: #fdf2f2; padding: 12px; border-radius: 4px; text-align: left; margin-top: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; width: 80%; max-width: 320px; }
    </style>
</head>
<body>

<div class="app-container" id="captureArea">
    <div id="inputForm">
        <div class="header"><h1>é£Ÿ çµ</h1><p>ì •ë°€ ì‹œì°¨ ë° ì²´ì§ˆ í†µí•© ë¶„ì„</p></div>
        <div class="content">
            <input type="text" id="userName" placeholder="ì„±í•¨ ë˜ëŠ” í˜¸(è™Ÿ)">
            <div class="section-title">ìƒë…„ì›”ì¼ ë° íƒ„ìƒ ì§€ì—­</div>
            <input type="date" id="birthDate" value="1995-01-01">
            <select id="birthCity">
                <option value="126.5">ì œì£¼, ëª©í¬, ì§„ë„ (-4ë¶„)</option>
                <option value="126.7">ì¸ì²œ, ì„œì‚°, ê°•í™” (-3ë¶„)</option>
                <option value="127.0" selected>ì„œìš¸, ê²½ê¸°, ê´‘ì£¼, ì „ì£¼ (ê¸°ì¤€ 0ë¶„)</option>
                <option value="127.3">ëŒ€ì „, ì²œì•ˆ, ì„¸ì¢…, ì²­ì£¼ (+1ë¶„)</option>
                <option value="127.5">ì›ì£¼, ì¶©ì£¼, ìˆœì²œ, ì—¬ìˆ˜ (+2ë¶„)</option>
                <option value="127.8">ì¶˜ì²œ, ì•ˆë™, êµ¬ë¯¸ (+3ë¶„)</option>
                <option value="128.2">ëŒ€êµ¬, ìƒì£¼, ì§„ì£¼ (+5ë¶„)</option>
                <option value="128.6">ë¶€ì‚°, ì°½ì›, ê±°ì œ (+6ë¶„)</option>
                <option value="129.0">ìš¸ì‚°, í¬í•­, ê°•ë¦‰ (+8ë¶„)</option>
                <option value="129.4">ìš¸ë¦‰ë„, ë…ë„ (+10ë¶„)</option>
            </select>
            <select id="birthTime">
                <option value="0">å­ì‹œ (23:30~)</option><option value="2">ä¸‘ì‹œ (01:30~)</option>
                <option value="4">å¯…ì‹œ (03:30~)</option><option value="6">å¯ì‹œ (05:30~)</option>
                <option value="8">è¾°ì‹œ (07:30~)</option><option value="10">å·³ì‹œ (09:30~)</option>
                <option value="12">åˆì‹œ (11:30~)</option><option value="14">æœªì‹œ (13:30~)</option>
                <option value="16">ç”³ì‹œ (15:30~)</option><option value="18">é…‰ì‹œ (17:30~)</option>
                <option value="20">æˆŒì‹œ (19:30~)</option><option value="22">äº¥ì‹œ (21:30~)</option>
            </select>
            <button onclick="showModal()">ì²˜ë°©ì „ ìƒì„±</button>
        </div>
    </div>

    <div id="prescriptionCard">
        <div id="cardMeta" style="font-size: 0.7rem; color: #999; margin-bottom: 15px;"></div>
        <div style="font-size: 0.8rem; font-weight: 700; color: var(--earth);" id="resBody"></div>
        <h2 id="resTitle" style="font-family: 'Song Myung', serif; font-size: 1.8rem; margin: 10px 0;"></h2>
        <div style="height: 180px; margin-bottom: 15px;"><canvas id="energyChart"></canvas></div>
        <div id="resDesc" style="font-size: 0.85rem; color: #555; margin-bottom: 15px;"></div>
        <div class="tag-box" id="resFoods"></div>
        <div class="warning-box" id="resWarning"></div>
        <div style="margin-top: 20px; font-size: 0.6rem; color: #ccc; letter-spacing: 3px;">SHIK-GYUL DIETARY SYSTEM</div>
    </div>
</div>

<div style="max-width:420px; margin: auto; padding: 0 15px 40px;">
    <button id="saveBtn" style="display:none; background: var(--wood);" onclick="saveAsImage()">ğŸ“¸ ì²˜ë°©ì „ ì´ë¯¸ì§€ ì €ì¥</button>
</div>

<div id="diagModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ì •ë°€ ì²´ì§ˆ í™•ì¸</h3>
        <p style="font-size:0.8rem; color:#666;">ë³¸ì¸ì˜ ì‹ ì²´ì  íŠ¹ì§•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        <div style="text-align:left; font-size:0.9rem;">
            <label><input type="radio" name="qBody" value="íƒœìŒì¸" checked> í—ˆë¦¬ê°€ ë°œë‹¬í•˜ê³  ì²´êµ¬ê°€ ë“¬ì§í•¨</label><br><br>
            <label><input type="radio" name="qBody" value="ì†ŒìŒì¸"> í•˜ì²´ê°€ ë°œë‹¬í•˜ê³  ìƒì²´ê°€ ê°€ëƒ˜í””</label><br><br>
            <label><input type="radio" name="qBody" value="ì†Œì–‘ì¸"> ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ê±¸ìŒì´ ë¹ ë¦„</label>
        </div>
        <button onclick="startAnalysis()" style="margin-top:20px;">ë¶„ì„ ì‹œì‘</button>
    </div>
</div>

<script>
    let chart=null;
    const elementMap = {'ç”²':'ëª©','ä¹™':'ëª©','å¯…':'ëª©','å¯':'ëª©','ä¸™':'í™”','ä¸':'í™”','å·³':'í™”','åˆ':'í™”','æˆŠ':'í† ','å·±':'í† ','è¾°':'í† ','æˆŒ':'í† ','ä¸‘':'í† ','æœª':'í† ','åºš':'ê¸ˆ','è¾›':'ê¸ˆ','ç”³':'ê¸ˆ','é…‰':'ê¸ˆ','å£¬':'ìˆ˜','ç™¸':'ìˆ˜','äº¥':'ìˆ˜','å­':'ìˆ˜'};
    const hansiDB = {
        'ëª©': { name: 'æœ¨ (ì²­ëŸ‰í•œ ìƒê¸°)', color: '#4A6741', desc: 'ê°„ ê¸°ìš´ì„ ë•ê³  í”¼ë¡œë¥¼ í•´ì†Œí•˜ëŠ” ìƒê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ëƒ‰ì´êµ­', 'ë¶€ì¶”ì „', 'ë¯¸ë‚˜ë¦¬ë¬´ì¹¨', 'ë¹„ë¹”ë°¥', 'ì• í”Œë¯¼íŠ¸ì°¨'] },
        'í™”': { name: 'ç« (ë”°ëœ»í•œ ì—ë„ˆì§€)', color: '#A24841', desc: 'ì‹¬ì¥ ìˆœí™˜ì„ í™œë°œíˆ í•˜ê³  ì •ì²´ëœ ê¸°ìš´ì„ ê¹¨ì›Œì•¼ í•©ë‹ˆë‹¤.', foods: ['ê¹€ì¹˜ì°Œê°œ', 'ì œìœ¡ë³¶ìŒ', 'ìœ¡ê°œì¥', 'ìˆœë‘ë¶€ì°Œê°œ', 'ìëª½ì—ì´ë“œ'] },
        'í† ': { name: 'åœŸ (ì•ˆì •ì˜ ì¤‘ì‹¬)', color: '#C29A5B', desc: 'ìœ„ì¥ì„ í¸ì•ˆí•˜ê²Œ ë‹¤ìŠ¤ë¦¬ê³  ê¸°ìš´ì„ ì•ˆì°©ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.', foods: ['ëœì¥ì°Œê°œ', 'ì²­êµ­ì¥', 'ì†Œê³ ê¸°ë­‡êµ­', 'ê°ìì¡°ë¦¼', 'ì‹í˜œ'] },
        'ê¸ˆ': { name: 'é‡‘ (ë‹¨ë‹¨í•œ ê²°ì‹¤)', color: '#7D7D7D', desc: 'íë¥¼ ë³´í˜¸í•˜ê³  ë©´ì—­ë ¥ì„ ë†’ì—¬ ëª¸ì„ ë‹¨ë‹¨íˆ ë§ºì–´ì•¼ í•©ë‹ˆë‹¤.', foods: ['ë‹­í•œë§ˆë¦¬', 'ìƒì„ êµ¬ì´', 'ë°°ìˆ™', 'ë§ˆëŠ˜ë³´ìŒˆ', 'ë¬´êµ­'] },
        'ìˆ˜': { name: 'æ°´ (ê¹Šì€ íœ´ì‹)', color: '#3E5266', desc: 'ì‹ ì¥ ì›ê¸°ë¥¼ ë³´ì¶©í•˜ê³  ëª¸ì˜ ì—´ì„ ì‹í˜€ì•¼ í•˜ëŠ” ë•Œì…ë‹ˆë‹¤.', foods: ['ë¯¸ì—­êµ­', 'í‰ì–‘ëƒ‰ë©´', 'ë³´ìŒˆ', 'ê²€ì€ì½©ìë°˜', 'ê¹€êµ¬ì´'] }
    };

    function showModal() { document.getElementById('diagModal').style.display='flex'; }

    function startAnalysis() {
        const name = document.getElementById('userName').value || 'ìµëª…';
        const body = document.querySelector('input[name="qBody"]:checked').value;
        const b = document.getElementById('birthDate').value;
        const cityLng = parseFloat(document.getElementById('birthCity').value);
        const time = parseInt(document.getElementById('birthTime').value);
        
        document.getElementById('diagModal').style.display='none';
        document.getElementById('inputForm').style.display='none';

        // 1. ì •ë°€ ì‹œì°¨ ë³´ì •
        const offsetMin = Math.round((cityLng - 127.0) * 4);
        const adjustedDate = new Date(new Date(b).getTime() + (time * 60 + offsetMin) * 60000);
        
        // 2. ì‚¬ì£¼ 8ì + ì˜¤ëŠ˜ 2ì ë¶„ì„ (ì´ 10ì)
        const solar = Solar.fromDate(adjustedDate);
        const eightChar = solar.getLunar().getEightChar();
        const tLunar = Solar.fromDate(new Date()).getLunar();
        
        let counts = {'ëª©':0,'í™”':0,'í† ':0,'ê¸ˆ':0,'ìˆ˜':0};
        const chars = [eightChar.getYearGan(), eightChar.getYearZhi(), eightChar.getMonthGan(), eightChar.getMonthZhi(),
                       eightChar.getDayGan(), eightChar.getDayZhi(), eightChar.getTimeGan(), eightChar.getTimeZhi(),
                       tLunar.getDayGan(), tLunar.getDayZhi()];
        chars.forEach(c => { if(elementMap[c]) counts[elementMap[c]]++; });

        const lack = Object.entries(counts).sort((a,b)=>a[1]-b[1])[0][0];

        // 3. UI ì—…ë°ì´íŠ¸
        document.getElementById('cardMeta').innerText = `${new Date().toLocaleDateString()} | ${name} ë‹˜`;
        document.getElementById('resBody').innerText = `[${body}]`;
        document.getElementById('resTitle').innerText = hansiDB[lack].name;
        document.getElementById('resTitle').style.color = hansiDB[lack].color;
        document.getElementById('resDesc').innerText = hansiDB[lack].desc;
        document.getElementById('resFoods').innerHTML = hansiDB[lack].foods.map(f => `<span class="food-tag">#${f}</span>`).join('');
        
        const warnings = {
            'íƒœìŒì¸': 'íƒœìŒì¸ì€ ìŠµ(æ¿•)ì´ ìŒ“ì´ë©´ ëª¸ì´ ë¬´ê±°ì›Œì§€ë‹ˆ ê³¼ì‹ê³¼ ê¸°ë¦„ì§„ ê³ ê¸°ë¥¼ í”¼í•˜ì„¸ìš”.',
            'ì†ŒìŒì¸': 'ì†ŒìŒì¸ì€ ë¹„ìœ„ê°€ ì°¨ê°€ìš°ë‹ˆ ì°¬ ë¬¼ì´ë‚˜ ì„±ì§ˆì´ ì°¬ ê³¼ì¼(ì°¸ì™¸ ë“±)ì„ ì£¼ì˜í•˜ì„¸ìš”.',
            'ì†Œì–‘ì¸': 'ì†Œì–‘ì¸ì€ ì—´ì´ ì˜¤ë¥´ê¸° ì‰¬ìš°ë‹ˆ ë§µê³  ìê·¹ì ì¸ ë³´ì–‘ì‹ë³´ë‹¤ëŠ” ë‹´ë°±í•œ ì‹ë‹¨ì´ ì¢‹ìŠµë‹ˆë‹¤.'
        };
        document.getElementById('resWarning').innerText = `âš ï¸ ì£¼ì˜: ${warnings[body]}`;

        renderChart(counts);
        document.getElementById('prescriptionCard').style.display = 'block';
        document.getElementById('saveBtn').style.display = 'block';
    }

    function renderChart(c) {
        const ctx = document.getElementById('energyChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ëª©','í™”','í† ','ê¸ˆ','ìˆ˜'],
                datasets: [{
                    data: [c['ëª©'], c['í™”'], c['í† '], c['ê¸ˆ'], c['ìˆ˜']],
                    backgroundColor: 'rgba(0,0,0,0.02)', borderColor: '#1a1a1a', borderWidth: 1, pointRadius: 2
                }]
            },
            options: { scales: { r: { min: 0, max: 6, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    function saveAsImage() {
        html2canvas(document.getElementById('prescriptionCard')).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì‹ê²°_ì²˜ë°©ì „_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
