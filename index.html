<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‹ê²°(é£Ÿçµ) - ì •ë°€ ìš´ëª… ì²˜ë°© ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Song+Myung&display=swap');
        
        :root { 
            --paper: #fdfcf8; --ink: #1a1a1a; 
            --wood: #4A6741; --fire: #A24841; --earth: #C29A5B; --metal: #7D7D7D; --water: #3E5266; 
        }

        body { font-family: 'Noto Serif KR', serif; background-color: #dcd9d0; margin: 0; padding: 15px; color: var(--ink); line-height: 1.6; }
        .app-container { max-width: 420px; margin: auto; background: var(--paper); border: 1px solid #c9c4b9; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        .header { padding: 45px 20px; text-align: center; border-bottom: 1px double #d1cdbf; background: #f9f7f0; }
        .header h1 { font-family: 'Song Myung', serif; font-size: 2.8rem; margin: 0; letter-spacing: 15px; text-indent: 15px; }
        .header p { font-size: 0.8rem; color: #777; margin-top: 10px; letter-spacing: 1px; }

        .content { padding: 30px 25px; }
        .section-title { font-size: 0.85rem; font-weight: 700; margin: 25px 0 12px; border-left: 3px solid var(--ink); padding-left: 10px; color: #444; }
        
        input, select { 
            width: 100%; border: none; border-bottom: 1px solid #d1cdbf; background: transparent; 
            padding: 12px 5px; margin-bottom: 18px; font-family: inherit; font-size: 1rem; outline: none; box-sizing: border-box; 
            transition: border-color 0.3s;
        }
        input:focus { border-bottom: 1px solid var(--ink); }

        button { 
            width: 100%; padding: 20px; background: var(--ink); color: #fff; border: none; 
            font-weight: 700; cursor: pointer; letter-spacing: 2px; margin-top: 15px; border-radius: 4px;
        }

        /* ì²˜ë°©ì „ ì¹´ë“œ ë””ìì¸ */
        #prescriptionCard { 
            display: none; background: var(--paper); padding: 35px 25px; 
            border: 12px double #d1cdbf; margin: 10px; text-align: center; position: relative; 
        }
        .tag-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .food-tag { padding: 6px 14px; border: 1px solid #d1cdbf; font-size: 0.85rem; border-radius: 4px; background: #fff; font-weight: 500; }
        
        .advice-box { font-size: 0.85rem; background: #f9f7f0; padding: 18px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee; text-align: left; line-height: 1.7; }
        .warning-box { font-size: 0.8rem; color: #a24841; background: #fdf2f2; padding: 15px; border-radius: 8px; text-align: left; border-left: 4px solid #a24841; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #fff; padding: 35px; width: 85%; max-width: 340px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        #saveBtn { margin-top: 20px; background: var(--wood); display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="inputForm">
        <div class="header">
            <h1>é£Ÿ çµ</h1>
            <p>ì²œë¬¸ ì‹œì°¨ ë° ê³„ì ˆ ê°€ì¤‘ì¹˜ í†µí•© ë¶„ì„</p>
        </div>
        <div class="content">
            <input type="text" id="userName" placeholder="ì„±í•¨ ë˜ëŠ” í˜¸(è™Ÿ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="section-title">ì¶œìƒ ì •ë³´</div>
            <input type="date" id="birthDate" value="1995-01-01">
            <select id="birthTime">
                <option value="0">å­ì‹œ (23:30~01:29)</option><option value="2">ä¸‘ì‹œ (01:30~03:29)</option>
                <option value="4">å¯…ì‹œ (03:30~05:29)</option><option value="6">å¯ì‹œ (05:30~07:29)</option>
                <option value="8">è¾°ì‹œ (07:30~09:29)</option><option value="10">å·³ì‹œ (09:30~11:29)</option>
                <option value="12">åˆì‹œ (11:30~13:29)</option><option value="14">æœªì‹œ (13:30~15:29)</option>
                <option value="16">ç”³ì‹œ (15:30~17:29)</option><option value="18">é…‰ì‹œ (17:30~19:29)</option>
                <option value="20">æˆŒì‹œ (19:30~21:29)</option><option value="22">äº¥ì‹œ (21:30~23:29)</option>
            </select>
            <div class="section-title">íƒ„ìƒ ì§€ì—­ (ê²½ë„ ì‹œì°¨ ë³´ì •)</div>
            <select id="birthCity">
                <option value="126.5">ì œì£¼, ëª©í¬, ì§„ë„ (-4ë¶„)</option>
                <option value="126.7">ì¸ì²œ, ì„œì‚°, ê°•í™” (-3ë¶„)</option>
                <option value="127.0" selected>ì„œìš¸, ê²½ê¸°, ê´‘ì£¼, ì „ì£¼ (ê¸°ì¤€ 0ë¶„)</option>
                <option value="127.3">ëŒ€ì „, ì„¸ì¢…, ì²­ì£¼ (+1ë¶„)</option>
                <option value="127.5">ì›ì£¼, ì¶©ì£¼, ìˆœì²œ (+2ë¶„)</option>
                <option value="127.8">ì¶˜ì²œ, ì•ˆë™, êµ¬ë¯¸ (+3ë¶„)</option>
                <option value="128.2">ëŒ€êµ¬, ì§„ì£¼ (+5ë¶„)</option>
                <option value="128.6">ë¶€ì‚°, ì°½ì›, ê±°ì œ (+6ë¶„)</option>
                <option value="129.0">ìš¸ì‚°, í¬í•­, ê°•ë¦‰ (+8ë¶„)</option>
            </select>
            <button onclick="showModal()">ì²˜ë°© ë¶„ì„ ì‹œì‘</button>
        </div>
    </div>

    <div id="prescriptionCard">
        <div id="cardMeta" style="font-size: 0.7rem; color: #999; margin-bottom: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <span id="resName"></span>
            <span id="resToday"></span>
        </div>
        <div style="font-size: 0.85rem; font-weight: 700; color: #666; letter-spacing: 2px;" id="resBody"></div>
        <h2 id="resTitle" style="font-family: 'Song Myung', serif; font-size: 2.2rem; margin: 15px 0;"></h2>
        <div style="height: 200px; margin: 20px 0;"><canvas id="energyChart"></canvas></div>
        <div id="resDesc" style="font-size: 0.9rem; color: #444; line-height: 1.8; word-break: keep-all;"></div>
        <div id="dailyAdvice" class="advice-box"></div>
        <div class="tag-box" id="resFoods"></div>
        <div class="warning-box" id="resWarning"></div>
        <div style="margin-top: 30px; font-size: 0.65rem; color: #bbb; letter-spacing: 4px; border-top: 1px solid #eee; pt: 15px;">SHIK-GYUL DIETARY SYSTEM</div>
    </div>
</div>

<div style="max-width:420px; margin: auto; padding: 0 15px 40px;">
    <button id="saveBtn" onclick="saveAsImage()">ğŸ“¸ ì²˜ë°©ì „ ì´ë¯¸ì§€ ì €ì¥</button>
</div>

<div id="diagModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; font-family: 'Song Myung'; font-size: 1.5rem;">ì‹ ì²´ ì§€í‘œ í™•ì¸</h3>
        <p style="font-size:0.85rem; color:#666; margin-bottom: 25px;">ê°€ì¥ ê°€ê¹Œìš´ íŠ¹ì§•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        <div style="text-align:left; font-size:0.95rem;">
            <label><input type="radio" name="qBody" value="íƒœìŒì¸" checked> í—ˆë¦¬ê°€ ë°œë‹¬í•˜ê³  ì²´êµ¬ê°€ ë“¬ì§í•¨</label><br><br>
            <label><input type="radio" name="qBody" value="ì†ŒìŒì¸"> í•˜ì²´ê°€ ë°œë‹¬í•˜ê³  ìƒì²´ê°€ ê°€ëƒ˜í””</label><br><br>
            <label><input type="radio" name="qBody" value="ì†Œì–‘ì¸"> ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ê±¸ìŒì´ ë¹ ë¦„</label>
        </div>
        <button onclick="startAnalysis()" style="margin-top:30px;">ë¶„ì„ ìƒì„±</button>
    </div>
</div>

<script>
    let chart = null;
    const elementMap = {
        'ç”²':'ëª©','ä¹™':'ëª©','å¯…':'ëª©','å¯':'ëª©',
        'ä¸™':'í™”','ä¸':'í™”','å·³':'í™”','åˆ':'í™”',
        'æˆŠ':'í† ','å·±':'í† ','è¾°':'í† ','æˆŒ':'í† ','ä¸‘':'í† ','æœª':'í† ',
        'åºš':'ê¸ˆ','è¾›':'ê¸ˆ','ç”³':'ê¸ˆ','é…‰':'ê¸ˆ',
        'å£¬':'ìˆ˜','ç™¸':'ìˆ˜','äº¥':'ìˆ˜','å­':'ìˆ˜'
    };
    
    const hansiDB = {
        'ëª©': { name: 'æœ¨ (ì²­ëŸ‰í•œ ìƒê¸°)', color: '#4A6741', desc: 'ê°„(è‚)ì˜ í•´ë… ê¸°ìš´ì„ ë•ê³  í”¼ë¡œë¥¼ í•´ì†Œí•˜ëŠ” ì‹ ë§›ê³¼ ì²­ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ëƒ‰ì´êµ­', 'ë¶€ì¶”ë¬´ì¹¨', 'ë¯¸ë‚˜ë¦¬', 'ë§¤ì‹¤ì°¨', 'ì‚¬ê³¼', 'ì˜¬ë¦¬ë¸Œìœ '] },
        'í™”': { name: 'ç« (ë”°ëœ»í•œ ì—ë„ˆì§€)', color: '#A24841', desc: 'ì‹¬ì¥ ìˆœí™˜ì„ í™œë°œíˆ í•˜ê³  ì •ì²´ëœ ìŠµí•œ ê¸°ìš´ì„ ë°œì‚°ì‹œí‚¤ëŠ” ì“´ë§›ê³¼ ì ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ìœ¡ê°œì¥', 'ì·¨ë‚˜ë¬¼', 'ìëª½', 'ìˆ˜ìˆ˜ë°¥', 'í† ë§ˆí† ', 'ê³ ì¶”ì¥'] },
        'í† ': { name: 'åœŸ (ì•ˆì •ì˜ ì¤‘ì‹¬)', color: '#C29A5B', desc: 'ë¹„ìœ„(è„¾èƒƒ)ë¥¼ í¸ì•ˆí•˜ê²Œ ë‹¤ìŠ¤ë¦¬ê³  ê¸°ìš´ì„ ì•ˆì°©ì‹œí‚¤ëŠ” ë‹¨ë§›ê³¼ í™©ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ëœì¥ì°Œê°œ', 'ë‹¨í˜¸ë°•ì£½', 'ê³ êµ¬ë§ˆ', 'ê°ìì¡°ë¦¼', 'ì°¸ì™¸', 'ê¿€'] },
        'ê¸ˆ': { name: 'é‡‘ (ë‹¨ë‹¨í•œ ê²°ì‹¤)', color: '#7D7D7D', desc: 'í(è‚º) ê¸°ëŠ¥ì„ ë³´í˜¸í•˜ê³  ë©´ì—­ë ¥ì„ ë†’ì´ëŠ” ë§¤ìš´ë§›ê³¼ ë°±ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ë‹­í•œë§ˆë¦¬', 'ë„ë¼ì§€ì²­', 'ë¬´êµ­', 'ë§ˆëŠ˜ë³´ìŒˆ', 'ì–‘íŒŒ', 'ë°°ìˆ™'] },
        'ìˆ˜': { name: 'æ°´ (ê¹Šì€ íœ´ì‹)', color: '#3E5266', desc: 'ì‹ ì¥(è…è‡Ÿ)ì˜ ì›ê¸°ë¥¼ ë³´ì¶©í•˜ê³  ì—´ì„ ì‹íˆëŠ” ì§ ë§›ê³¼ í‘ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ë¯¸ì—­êµ­', 'ê²€ì€ì½©ìë°˜', 'ê¹€êµ¬ì´', 'ë¸”ë£¨ë² ë¦¬', 'ë³´ìŒˆ', 'í‘ë¯¸ë°¥'] }
    };

    function showModal() { document.getElementById('diagModal').style.display='flex'; }

    function startAnalysis() {
        const name = document.getElementById('userName').value || 'ìµëª…';
        const body = document.querySelector('input[name="qBody"]:checked').value;
        const b = document.getElementById('birthDate').value;
        const cityLng = parseFloat(document.getElementById('birthCity').value);
        const time = parseInt(document.getElementById('birthTime').value);
        
        document.getElementById('diagModal').style.display='none';
        document.getElementById('inputForm').style.display='none';

        // 1. ì‹œì°¨ ë³´ì • ë¡œì§ (í‘œì¤€ì‹œ 135ë„ ê¸°ì¤€ ê²½ë„ ì°¨ì´ ê³„ì‚°)
        const offsetMin = Math.round((cityLng - 127.0) * 4); // ì„œìš¸ ê¸°ì¤€ ìƒëŒ€ ì‹œì°¨
        const birthDateTime = new Date(new Date(b).getTime() + (time * 60 + offsetMin) * 60000);
        
        const solar = Solar.fromDate(birthDateTime);
        const lunar = solar.getLunar();
        const eightChar = lunar.getEightChar();
        const tSolar = Solar.fromDate(new Date());
        const tLunar = tSolar.getLunar();
        
        // 2. ì˜¤í–‰ ë¶„ì„ ë° ê°€ì¤‘ì¹˜ ì ìš© (ì›”ì§€ ê°€ì¤‘ì¹˜ ë¶€ì—¬)
        let counts = {'ëª©':0,'í™”':0,'í† ':0,'ê¸ˆ':0,'ìˆ˜':0};
        const chars = [
            {v: eightChar.getYearGan(), w: 1}, {v: eightChar.getYearZhi(), w: 1},
            {v: eightChar.getMonthGan(), w: 1.2}, {v: eightChar.getMonthZhi(), w: 2.0}, // ì›”ì§€ëŠ” ê³„ì ˆì˜ ì£¼ê¶Œìë¡œ ê°€ì¤‘ì¹˜ ë†’ìŒ
            {v: eightChar.getDayGan(), w: 1.5}, {v: eightChar.getDayZhi(), w: 1},
            {v: eightChar.getTimeGan(), w: 1}, {v: eightChar.getTimeZhi(), w: 1}
        ];

        chars.forEach(item => {
            const el = elementMap[item.v];
            if(el) counts[el] += item.w;
        });

        // 3. ë¶€ì¡±í•œ ì˜¤í–‰ ì¶”ì¶œ (ì ìˆ˜ê°€ ê°€ì¥ ë‚®ì€ ê²ƒ)
        const sorted = Object.entries(counts).sort((a,b) => a[1] - b[1]);
        const lack = sorted[0][0];
        const todayElement = elementMap[tLunar.getDayGan()];

        // UI ë Œë”ë§
        document.getElementById('resName').innerText = `${name} ë‹˜`;
        document.getElementById('resToday').innerText = `${tSolar.toYmd()} ì²˜ë°©`;
        document.getElementById('resBody').innerText = `[${body} ì²´ì§ˆ ë¶„ì„]`;
        document.getElementById('resTitle').innerText = hansiDB[lack].name;
        document.getElementById('resTitle').style.color = hansiDB[lack].color;
        document.getElementById('resDesc').innerText = hansiDB[lack].desc;
        document.getElementById('resFoods').innerHTML = hansiDB[lack].foods.map(f => `<span class="food-tag">#${f}</span>`).join('');
        
        // ì¡°ì–¸ ë¡œì§
        let adviceText = `ì˜¤ëŠ˜ì€ <strong>${todayElement}</strong>ì˜ ê¸°ìš´ì´ íë¥´ëŠ” ë‚ ì…ë‹ˆë‹¤. `;
        if(todayElement === lack) {
            adviceText += `ë¶€ì¡±í•œ ê¸°ìš´ì´ ë³´ê°•ë˜ëŠ” ê¸¸í•œ ë‚ ì´ë‹ˆ, ì²˜ë°© ì‹ë‹¨ì„ í†µí•´ ê¸°ìš´ì„ ì™„ì „íˆ í¡ìˆ˜í•˜ì‹­ì‹œì˜¤.`;
        } else {
            adviceText += `ì™¸ë¶€ì˜ ê°•í•œ ê¸°ìš´ì— íœ©ì“¸ë¦¬ì§€ ì•Šë„ë¡ ë‹´ë°±í•œ ì²˜ë°©ì‹ìœ¼ë¡œ ë‚´ë©´ì˜ ì¤‘ì‹¬ì„ ì¡ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`;
        }
        document.getElementById('dailyAdvice').innerHTML = adviceText;

        const warnings = {
            'íƒœìŒì¸': 'ìŠµ(æ¿•)ì´ ìŒ“ì´ê¸° ì‰¬ìš°ë‹ˆ ê³¼ì‹ì„ ê¸ˆí•˜ê³  ìœ ì‚°ì†Œ ìš´ë™ìœ¼ë¡œ ë•€ì„ ë‚´ì–´ ìˆœí™˜ì„ ë•ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.',
            'ì†ŒìŒì¸': 'ë¹„ìœ„ê°€ ì°¨ê°€ì›Œì§€ê¸° ì‰¬ìš°ë‹ˆ ì–¼ìŒë¬¼ì´ë‚˜ ë‚ ê²ƒì„ í”¼í•˜ê³  ëª¨ë“  ìŒì‹ì€ ë”°ëœ»í•˜ê²Œ ë°ì›Œ ë“œì„¸ìš”.',
            'ì†Œì–‘ì¸': 'ì‹¬ì—´(å¿ƒç†±)ì´ ì‰½ê²Œ ì˜¤ë¥´ë‹ˆ ìê·¹ì ì¸ ê³ ì¶”, ë§ˆëŠ˜ë³´ë‹¤ëŠ” ìˆ˜ë¶„ì´ ë§ì€ ì±„ì†Œ ìœ„ì£¼ë¡œ ë“œì‹œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.'
        };
        document.getElementById('resWarning').innerText = `âš ï¸ ì£¼ì˜: ${warnings[body]}`;

        renderChart(counts, lack);
        document.getElementById('prescriptionCard').style.display = 'block';
        document.getElementById('saveBtn').style.display = 'block';
    }

    function renderChart(c, lack) {
        const ctx = document.getElementById('energyChart').getContext('2d');
        const themeColor = hansiDB[lack].color;
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ëª©','í™”','í† ','ê¸ˆ','ìˆ˜'],
                datasets: [{
                    data: [c['ëª©'], c['í™”'], c['í† '], c['ê¸ˆ'], c['ìˆ˜']],
                    backgroundColor: themeColor + '33',
                    borderColor: themeColor,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: themeColor,
                    fill: true
                }]
            },
            options: {
                scales: { 
                    r: { 
                        min: 0, 
                        suggestedMax: 5,
                        ticks: { display: false },
                        grid: { color: '#e0e0e0' },
                        angleLines: { color: '#e0e0e0' },
                        pointLabels: { font: { size: 14, weight: '700' } }
                    } 
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function saveAsImage() {
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = "â³ ê³ í™”ì§ˆ ìƒì„± ì¤‘...";
        
        html2canvas(document.getElementById('prescriptionCard'), {
            scale: 3, // ì¸ì‡„ê¸‰ ê³ í™”ì§ˆ
            useCORS: true,
            backgroundColor: "#fdfcf8"
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì‹ê²°_ì²˜ë°©ì „_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerText = originalText;
        });
    }
</script>
</body>
</html>
