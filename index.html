<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‹ê²°(é£Ÿçµ) - ì •ë°€ ìš´ëª… ì²˜ë°© ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Song+Myung&display=swap');
        
        :root { 
            --paper: #fdfcf8; --ink: #1a1a1a; 
            --wood: #4A6741; --fire: #A24841; --earth: #C29A5B; --metal: #7D7D7D; --water: #3E5266; 
        }

        body { font-family: 'Noto Serif KR', serif; background-color: #dcd9d0; margin: 0; padding: 15px; color: var(--ink); line-height: 1.6; }
        .app-container { max-width: 420px; margin: auto; background: var(--paper); border: 1px solid #c9c4b9; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        .header { padding: 45px 20px; text-align: center; border-bottom: 1px double #d1cdbf; background: #f9f7f0; }
        .header h1 { font-family: 'Song Myung', serif; font-size: 2.8rem; margin: 0; letter-spacing: 15px; text-indent: 15px; }
        .header p { font-size: 0.8rem; color: #777; margin-top: 10px; letter-spacing: 1px; }

        .content { padding: 30px 25px; }
        .section-title { font-size: 0.85rem; font-weight: 700; margin: 25px 0 12px; border-left: 3px solid var(--ink); padding-left: 10px; color: #444; }
        
        input, select { 
            width: 100%; border: none; border-bottom: 1px solid #d1cdbf; background: transparent; 
            padding: 12px 5px; margin-bottom: 18px; font-family: inherit; font-size: 1rem; outline: none; box-sizing: border-box; 
        }

        button { 
            width: 100%; padding: 18px; background: var(--ink); color: #fff; border: none; 
            font-weight: 700; cursor: pointer; letter-spacing: 2px; border-radius: 4px; transition: 0.3s;
        }

        /* ì„¤ë¬¸ì§€ ë„¤ëª¨ ë²„íŠ¼ */
        .survey-item { margin-bottom: 25px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .survey-question { font-size: 0.95rem; font-weight: 700; margin-bottom: 12px; color: #333; text-align: left; }
        .option-group { display: flex; gap: 8px; flex-direction: column; }
        .option-group label {
            display: block; padding: 12px; border: 1px solid #d1cdbf; background: #fff; 
            font-size: 0.85rem; cursor: pointer; border-radius: 4px; text-align: left;
        }
        .option-group input[type="radio"] { display: none; }
        .option-group label:has(input:checked) { background: var(--ink); color: #fff; border-color: var(--ink); }

        /* ì²˜ë°©ì „ ì¹´ë“œ ë° ë‚™ê´€ */
        #prescriptionCard { 
            display: none; background: var(--paper); padding: 35px 25px; 
            border: 12px double #d1cdbf; margin: 10px; text-align: center; position: relative; 
        }
        .seal {
            position: absolute; bottom: 30px; right: 25px; width: 45px; height: 45px; 
            border: 2px solid #a24841; color: #a24841; font-family: 'Song Myung'; font-weight: bold;
            display: flex; align-items: center; justify-content: center; line-height: 1.2;
            transform: rotate(-10deg); opacity: 0.7; font-size: 1.1rem; pointer-events: none;
        }
        .tag-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .food-tag { padding: 5px 12px; border: 1px solid #d1cdbf; font-size: 0.8rem; border-radius: 4px; background: #fff; }
        .advice-box { font-size: 0.85rem; background: #f9f7f0; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #eee; text-align: left; }
        .warning-box { font-size: 0.8rem; color: #a24841; background: #fdf2f2; padding: 12px; border-radius: 8px; text-align: left; border-left: 4px solid #a24841; }
        .lucky-color-box { display: inline-block; padding: 2px 8px; border-radius: 4px; color: #fff; font-size: 0.75rem; vertical-align: middle; }

        /* ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
        .search-container { position: relative; flex: 1; }
        #autocomplete-list {
            position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; background-color: #fff; max-height: 150px; overflow-y: auto;
        }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4; font-size: 0.85rem; text-align: left; }
        .autocomplete-item:hover { background-color: #e9e9e9; }

        /* ì»¨íŠ¸ë¡¤ ì„¹ì…˜ */
        #controlSection { display: none; max-width: 420px; margin: 20px auto; padding: 0 15px 40px; }
        .search-box { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn-secondary { background: #7d7d7d; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 25px; width: 85%; max-width: 360px; border-radius: 12px; max-height: 85vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="inputForm">
        <div class="header"><h1>é£Ÿ çµ</h1><p>ì •ë°€ ì‹œì°¨ ë° ê³„ì ˆ í†µí•© ë¶„ì„ ì‹œìŠ¤í…œ</p></div>
        <div class="content">
            <input type="text" id="userName" placeholder="ì„±í•¨ ë˜ëŠ” í˜¸(è™Ÿ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="section-title">ì¶œìƒ ì •ë³´</div>
            <input type="date" id="birthDate" value="1995-01-01">
            <select id="birthTime">
                <option value="0">å­ì‹œ (23:30~01:29)</option><option value="2">ä¸‘ì‹œ (01:30~03:29)</option>
                <option value="4">å¯…ì‹œ (03:30~05:29)</option><option value="6">å¯ì‹œ (05:30~07:29)</option>
                <option value="8">è¾°ì‹œ (07:30~09:29)</option><option value="10">å·³ì‹œ (09:30~11:29)</option>
                <option value="12">åˆì‹œ (11:30~13:29)</option><option value="14">æœªì‹œ (13:30~15:29)</option>
                <option value="16">ç”³ì‹œ (15:30~17:29)</option><option value="18">é…‰ì‹œ (17:30~19:29)</option>
                <option value="20">æˆŒì‹œ (19:30~21:29)</option><option value="22">äº¥ì‹œ (21:30~23:29)</option>
            </select>
            <div class="section-title">ì¶œìƒì§€ (ì‹œì°¨ ë³´ì •)</div>
            <select id="birthCity">
                <option value="127.0" selected>ì„œìš¸, ê²½ê¸°, ì „ì£¼ (ê¸°ì¤€ 0ë¶„)</option>
                <option value="126.5">ì œì£¼, ëª©í¬ (-4ë¶„)</option>
                <option value="128.6">ë¶€ì‚°, ì°½ì› (+6ë¶„)</option>
                <option value="129.0">ìš¸ì‚°, í¬í•­ (+8ë¶„)</option>
            </select>
            <button onclick="showModal()">ì²´ì§ˆ ì§„ë‹¨ ì‹œì‘</button>
        </div>
    </div>

    <div id="prescriptionCard">
        <div id="cardMeta" style="font-size: 0.65rem; color: #999; margin-bottom: 15px; display: flex; justify-content: space-between;">
            <span id="resName"></span><span id="resToday"></span>
        </div>
        <div id="resBody" style="font-size: 0.8rem; font-weight: 700; color: #888;"></div>
        <div id="luckyColor" style="margin: 10px 0;"></div>
        <h2 id="resTitle" style="font-family: 'Song Myung', serif; font-size: 2rem; margin: 5px 0;"></h2>
        <div style="height: 180px; margin: 15px 0;"><canvas id="energyChart"></canvas></div>
        <div id="resDesc" style="font-size: 0.85rem; color: #444; word-break: keep-all;"></div>
        <div id="dailyAdvice" class="advice-box"></div>
        <div class="tag-box" id="resFoods"></div>
        <div id="resWarning" class="warning-box"></div>
        <div class="seal">é£Ÿ<br>çµ</div>
    </div>
</div>

<div id="controlSection">
    <div class="search-box">
        <div style="font-size: 0.85rem; font-weight: 700; margin-bottom: 10px;">ğŸ” ìŒì‹ ê¶í•© í™•ì¸ (ìë™ì™„ì„±)</div>
        <div style="display: flex; gap: 5px;">
            <div class="search-container">
                <input type="text" id="foodQuery" placeholder="ìŒì‹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:0; border: 1px solid #ddd; padding: 10px;">
                <div id="autocomplete-list"></div>
            </div>
            <button onclick="checkFoodMatch()" style="width: auto; padding: 0 15px; font-size: 0.8rem;">ê²€ìƒ‰</button>
        </div>
        <div id="foodMatchResult" style="font-size: 0.85rem; margin-top: 15px; font-weight: bold; line-height: 1.5;"></div>
    </div>
    <div class="action-buttons">
        <button class="btn-secondary" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
        <button onclick="saveAsImage()">ğŸ“¸ ì²˜ë°©ì „ ì €ì¥</button>
    </div>
</div>

<div id="diagModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; font-family: 'Song Myung';">ì •ë°€ ì²´ì§ˆ ì§„ë‹¨</h3>
        <div id="surveyContainer">
            <div class="survey-item">
                <div class="survey-question">1. í‰ì†Œ ì²´í˜•ê³¼ ê³¨ê²©ì€?</div>
                <div class="option-group">
                    <label><input type="radio" name="q1" value="íƒœìŒì¸" checked> <span>ê³¨ê²©ì´ í¬ê³  í—ˆë¦¬ ë¶€ìœ„ê°€ ë°œë‹¬í•¨</span></label>
                    <label><input type="radio" name="q1" value="ì†ŒìŒì¸"> <span>í•˜ì²´ê°€ ë°œë‹¬í•˜ê³  ì „ì²´ì ìœ¼ë¡œ ê°€ëƒ˜í”ˆ í¸</span></label>
                    <label><input type="radio" name="q1" value="ì†Œì–‘ì¸"> <span>ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ì—‰ë©ì´ê°€ ì‘ê³  ê°€ë²¼ì›€</span></label>
                </div>
            </div>
            <div class="survey-item">
                <div class="survey-question">2. ì„±ê²©ì´ë‚˜ ì¼ ì²˜ë¦¬ ë°©ì‹ì€?</div>
                <div class="option-group">
                    <label><input type="radio" name="q2" value="íƒœìŒì¸"> <span>ëŠê¸‹í•˜ê³  ì°¸ì„ì„±ì´ ë§ìœ¼ë©° ë³´ìˆ˜ì ì„</span></label>
                    <label><input type="radio" name="q2" value="ì†ŒìŒì¸"> <span>ì„¸ì‹¬í•˜ê³  ê¼¼ê¼¼í•˜ë©° ë‚´ì„±ì ì¸ í¸ì„</span></label>
                    <label><input type="radio" name="q2" value="ì†Œì–‘ì¸"> <span>íŒë‹¨ì´ ë¹ ë¥´ê³  ì†”ì§í•˜ë©° í–‰ë™ì´ ì•ì„¬</span></label>
                </div>
            </div>
            <div class="survey-item">
                <div class="survey-question">3. ì†Œí™” ìƒíƒœì™€ ì°¬ ìŒì‹ ë°˜ì‘ì€?</div>
                <div class="option-group">
                    <label><input type="radio" name="q3" value="ì†ŒìŒì¸"> <span>ì°¬ ê²ƒì„ ë¨¹ìœ¼ë©´ ì„¤ì‚¬í•˜ê±°ë‚˜ ë°°ê°€ ì•„í””</span></label>
                    <label><input type="radio" name="q3" value="ì†Œì–‘ì¸"> <span>ì‹œì›í•œ ë¬¼ì´ë‚˜ ëƒ‰ë©´ ë“± ì°¬ ìŒì‹ì„ ì¦ê¹€</span></label>
                    <label><input type="radio" name="q3" value="íƒœìŒì¸"> <span>ì†Œí™”ë ¥ì´ ì¢‹ì•„ ë¬´ì—‡ì´ë“  ì˜ ë¨¹ëŠ” í¸ì„</span></label>
                </div>
            </div>
            <div class="survey-item">
                <div class="survey-question">4. ê±´ê°•ì´ ê°€ì¥ ì¢‹ì„ ë•ŒëŠ”?</div>
                <div class="option-group">
                    <label><input type="radio" name="q4" value="íƒœìŒì¸"> <span>ë•€ì„ ì‹œì›í•˜ê²Œ í˜ë¦¬ê³  ë‚¬ì„ ë•Œ</span></label>
                    <label><input type="radio" name="q4" value="ì†ŒìŒì¸"> <span>ìŒì‹ ì†Œí™”ê°€ ì•„ì£¼ í¸ì•ˆí•˜ê²Œ ë  ë•Œ</span></label>
                    <label><input type="radio" name="q4" value="ì†Œì–‘ì¸"> <span>ëŒ€ë³€ í™œë™ì´ ì‹œì›í•˜ê²Œ ì˜ ì†Œí†µë  ë•Œ</span></label>
                </div>
            </div>
        </div>
        <button onclick="startAnalysis()">ê²°ê³¼ ë³´ê¸°</button>
    </div>
</div>

<script>
    let chart = null;
    let currentBody = "";
    const elementMap = {'ç”²':'ëª©','ä¹™':'ëª©','å¯…':'ëª©','å¯':'ëª©','ä¸™':'í™”','ä¸':'í™”','å·³':'í™”','åˆ':'í™”','æˆŠ':'í† ','å·±':'í† ','è¾°':'í† ','æˆŒ':'í† ','ä¸‘':'í† ','æœª':'í† ','åºš':'ê¸ˆ','è¾›':'ê¸ˆ','ç”³':'ê¸ˆ','é…‰':'ê¸ˆ','å£¬':'ìˆ˜','ç™¸':'ìˆ˜','äº¥':'ìˆ˜','å­':'ìˆ˜'};
    const luckyColors = {'ëª©':{n:'ì²­ë¡ìƒ‰',c:'#4A6741'},'í™”':{n:'ì§„í™ìƒ‰',c:'#A24841'},'í† ':{n:'í™©ê¸ˆìƒ‰',c:'#C29A5B'},'ê¸ˆ':{n:'ë°±ì€ìƒ‰',c:'#999999'},'ìˆ˜':{n:'ì‹¬í•´ìƒ‰',c:'#3E5266'}};
    
    const foodDB = {
        'ì†ŒìŒì¸': {
            good: ['ë‹­ê³ ê¸°','ì¸ì‚¼','ëŒ€ì¶”','ìƒê°•','ì‚¬ê³¼','ì°¹ìŒ€','ë¯¸ê¾¸ë¼ì§€','ë¶€ì¶”','ì‹œê¸ˆì¹˜','ì¹´ë ˆ'],
            bad: ['ë¼ì§€ê³ ê¸°','ì°¬ë¬¼','ìˆ˜ë°•','ì°¸ì™¸','ë³´ë¦¬','ë©”ë°€','ë°€ê°€ë£¨','ì˜¤ì´','ë§¥ì£¼']
        },
        'ì†Œì–‘ì¸': {
            good: ['ë¼ì§€ê³ ê¸°','ì˜¤ë¦¬ê³ ê¸°','ì˜¤ì´','ìˆ˜ë°•','ì „ë³µ','êµ´','ë³´ë¦¬','ì°¸ì™¸','ë”¸ê¸°','ë…¹ì°¨'],
            bad: ['ë‹­ê³ ê¸°','ì¸ì‚¼','ìƒê°•','ê³ ì¶”','ê¿€','ì‚¬ê³¼','ê·¤','ì˜¤ë Œì§€','ì¹´ë ˆ']
        },
        'íƒœìŒì¸': {
            good: ['ì†Œê³ ê¸°','ìš°ìœ ','ë¬´','ì—°ê·¼','ê³ êµ¬ë§ˆ','ë°°','ì½©','ë“¤ê¹¨','ìœ¨ë¬´','ë„ë¼ì§€'],
            bad: ['ë‹­ê³ ê¸°','ì¡°ê°œë¥˜','ìƒˆìš°','ë©”ë°€','ë°°ì¶”','ì»¤í”¼','ìˆ ']
        }
    };

    const allFoods = Array.from(new Set([...foodDB.ì†ŒìŒì¸.good, ...foodDB.ì†ŒìŒì¸.bad, ...foodDB.ì†Œì–‘ì¸.good, ...foodDB.ì†Œì–‘ì¸.bad, ...foodDB.íƒœìŒì¸.good, ...foodDB.íƒœìŒì¸.bad]));

    const hansiDB = {
        'ëª©': { name: 'æœ¨ (ì²­ëŸ‰í•œ ìƒê¸°)', color: '#4A6741', desc: 'ê°„(è‚)ì˜ í•´ë… ê¸°ìš´ì„ ë•ëŠ” ì‹ ë§›ê³¼ ì²­ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ëƒ‰ì´', 'ë¶€ì¶”', 'ë¯¸ë‚˜ë¦¬', 'ë§¤ì‹¤'] },
        'í™”': { name: 'ç« (ë”°ëœ»í•œ ì—ë„ˆì§€)', color: '#A24841', desc: 'ì‹¬ì¥ ìˆœí™˜ì„ í™œë°œíˆ í•˜ëŠ” ì“´ë§›ê³¼ ì ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ìœ¡ê°œì¥', 'ì·¨ë‚˜ë¬¼', 'ìëª½', 'ìˆ˜ìˆ˜'] },
        'í† ': { name: 'åœŸ (ì•ˆì •ì˜ ì¤‘ì‹¬)', color: '#C29A5B', desc: 'ë¹„ìœ„(è„¾èƒƒ)ë¥¼ ë‹¤ìŠ¤ë¦¬ëŠ” ë‹¨ë§›ê³¼ í™©ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ë‹¨í˜¸ë°•', 'ê³ êµ¬ë§ˆ', 'ê°ì', 'ê¿€'] },
        'ê¸ˆ': { name: 'é‡‘ (ë‹¨ë‹¨í•œ ê²°ì‹¤)', color: '#7D7D7D', desc: 'í(è‚º) ê¸°ëŠ¥ì„ ë³´í˜¸í•˜ëŠ” ë§¤ìš´ë§›ê³¼ ë°±ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ë‹­ê³ ê¸°', 'ë¬´êµ­', 'ë§ˆëŠ˜', 'ë°°'] },
        'ìˆ˜': { name: 'æ°´ (ê¹Šì€ íœ´ì‹)', color: '#3E5266', desc: 'ì‹ ì¥(è…è‡Ÿ)ì˜ ì›ê¸°ë¥¼ ë³´ì¶©í•˜ëŠ” ì§ ë§›ê³¼ í‘ìƒ‰ ì‹ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.', foods: ['ë¯¸ì—­', 'ê²€ì€ì½©', 'ê¹€', 'ë¸”ë£¨ë² ë¦¬'] }
    };

    function showModal() { document.getElementById('diagModal').style.display='flex'; }

    function startAnalysis() {
        const name = document.getElementById('userName').value || 'ìµëª…';
        let s = {'íƒœìŒì¸':0,'ì†ŒìŒì¸':0,'ì†Œì–‘ì¸':0};
        [1,2,3,4].forEach(i => { 
            const val = document.querySelector(`input[name="q${i}"]:checked`).value;
            s[val]++; 
        });
        currentBody = Object.keys(s).reduce((a, b) => s[a] >= s[b] ? a : b);

        const b = document.getElementById('birthDate').value;
        const cityLng = parseFloat(document.getElementById('birthCity').value);
        const time = parseInt(document.getElementById('birthTime').value);
        const offsetMin = Math.round((cityLng - 127.0) * 4);
        const bDate = new Date(new Date(b).getTime() + (time * 60 + offsetMin) * 60000);
        
        const solar = Solar.fromDate(bDate);
        const lunar = solar.getLunar();
        const eightChar = lunar.getEightChar();
        const tLunar = Solar.fromDate(new Date()).getLunar();
        
        let counts = {'ëª©':0,'í™”':0,'í† ':0,'ê¸ˆ':0,'ìˆ˜':0};
        const chars = [
            {v:eightChar.getYearGan(),w:1},{v:eightChar.getYearZhi(),w:1},
            {v:eightChar.getMonthGan(),w:1.2},{v:eightChar.getMonthZhi(),w:2.0},
            {v:eightChar.getDayGan(),w:1.5},{v:eightChar.getDayZhi(),w:1},
            {v:eightChar.getTimeGan(),w:1},{v:eightChar.getTimeZhi(),w:1}
        ];
        chars.forEach(i => { if(elementMap[i.v]) counts[elementMap[i.v]] += i.w; });

        const lack = Object.entries(counts).sort((a,b)=>a[1]-b[1])[0][0];
        
        document.getElementById('resName').innerText = `${name} ë‹˜`;
        document.getElementById('resToday').innerText = `${tLunar.toYmd()} (${tLunar.getDayInGanZhi()}ì¼)`;
        document.getElementById('resBody').innerText = `[ ì •ë°€ ì²´ì§ˆ ë¶„ì„: ${currentBody} ]`;
        document.getElementById('luckyColor').innerHTML = `í–‰ìš´ìƒ‰: <span class="lucky-color-box" style="background:${luckyColors[lack].c}">${luckyColors[lack].n}</span>`;
        document.getElementById('resTitle').innerText = hansiDB[lack].name;
        document.getElementById('resTitle').style.color = hansiDB[lack].color;
        document.getElementById('resDesc').innerText = hansiDB[lack].desc;
        document.getElementById('resFoods').innerHTML = hansiDB[lack].foods.map(f => `<span class="food-tag">#${f}</span>`).join('');
        
        document.getElementById('dailyAdvice').innerHTML = `ì˜¤ëŠ˜ì˜ ê¸°ìš´ì€ <strong>${elementMap[tLunar.getDayGan()]}</strong>ì…ë‹ˆë‹¤. ì²˜ë°© ì‹ë‹¨ì„ í†µí•´ ê· í˜•ì„ ë§ì¶”ì„¸ìš”.`;
        const warns = {'íƒœìŒì¸':'ìŠµ(æ¿•)ì„ ì£¼ì˜í•˜ê³  ê³¼ì‹ì„ í”¼í•˜ì„¸ìš”.','ì†ŒìŒì¸':'ëƒ‰ì¦ì„ í”¼í•˜ê³  í•­ìƒ ë”°ëœ»í•˜ê²Œ ë“œì„¸ìš”.','ì†Œì–‘ì¸':'í™”(ç«)ê°€ ì˜¤ë¥´ê¸° ì‰¬ìš°ë‹ˆ ë‹´ë°±í•˜ê²Œ ë“œì„¸ìš”.'};
        document.getElementById('resWarning').innerText = `âš ï¸ ì£¼ì˜: ${warns[currentBody]}`;

        renderChart(counts, hansiDB[lack].color);
        document.getElementById('diagModal').style.display = 'none';
        document.getElementById('inputForm').style.display = 'none';
        document.getElementById('prescriptionCard').style.display = 'block';
        document.getElementById('controlSection').style.display = 'block';
    }

    function renderChart(c, col) {
        const ctx = document.getElementById('energyChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ëª©','í™”','í† ','ê¸ˆ','ìˆ˜'],
                datasets: [{ data: Object.values(c), backgroundColor: col+'33', borderColor: col, borderWidth: 2, pointRadius: 3 }]
            },
            options: { scales: { r: { min: 0, suggestedMax: 4, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    // ìë™ì™„ì„± ê¸°ëŠ¥
    const foodInput = document.getElementById('foodQuery');
    const autoList = document.getElementById('autocomplete-list');

    foodInput.addEventListener('input', function() {
        const val = this.value;
        autoList.innerHTML = '';
        if (!val) return false;
        const matches = allFoods.filter(f => f.includes(val));
        matches.forEach(m => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = `<strong>${m.substr(0, val.length)}</strong>${m.substr(val.length)}`;
            item.addEventListener('click', function() {
                foodInput.value = m;
                autoList.innerHTML = '';
                checkFoodMatch();
            });
            autoList.appendChild(item);
        });
    });

    document.addEventListener('click', (e) => { if(e.target !== foodInput) autoList.innerHTML = ''; });

    function checkFoodMatch() {
        const q = foodInput.value.trim();
        const res = document.getElementById('foodMatchResult');
        if(!q) return;
        const db = foodDB[currentBody];
        const isGood = db.good.some(f => q.includes(f));
        const isBad = db.bad.some(f => q.includes(f));

        if(isGood) { res.innerHTML = `âœ… <span style="color:var(--wood)">ì¢‹ìŒ:</span> ${q}(ì€)ëŠ” ${currentBody}ì—ê²Œ ë³´ì•½ê³¼ ê°™ìŠµë‹ˆë‹¤.`; }
        else if(isBad) { res.innerHTML = `âŒ <span style="color:var(--fire)">ì£¼ì˜:</span> ${q}(ì€)ëŠ” ${currentBody}ì—ê²Œ í•´ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`; }
        else { res.innerHTML = `ğŸ¤” <strong>ì•Œ ìˆ˜ ì—†ìŒ:</strong> ${q}ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¬´ë‚œíˆ ë“œì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.`; }
    }

    function saveAsImage() {
        html2canvas(document.getElementById('prescriptionCard'), { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì‹ê²°_ì²˜ë°©ì „.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
